{% extends "base.html" %}

{% block title %}Session Replay - PAD Annotation System{% endblock %}

{% block head %}
<style>
    .layout {
        display: grid;
        grid-template-columns: 240px 1fr 300px;
        min-height: 100vh;
    }

    .sidebar {
        background: var(--sidebar-color);
        border-right: 1px solid var(--border-color);
        padding: 20px;
    }

    .sidebar-header h1 {
        font-size: 1.1rem;
        color: var(--primary-color);
    }

    .sidebar-header p {
        font-size: 0.8rem;
        color: var(--text-muted);
        margin-top: 4px;
    }

    .nav-menu {
        list-style: none;
        margin-top: 30px;
    }

    .nav-item {
        margin-bottom: 4px;
    }

    .nav-link {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 12px;
        border-radius: 8px;
        color: var(--text-color);
        text-decoration: none;
        font-size: 0.9rem;
    }

    .nav-link:hover {
        background: rgba(255, 255, 255, 0.05);
        text-decoration: none;
    }

    .logout-link {
        margin-top: auto;
        padding-top: 20px;
        border-top: 1px solid var(--border-color);
    }

    .logout-link .user-info {
        padding: 10px 12px;
        font-size: 0.85rem;
        color: var(--text-muted);
    }

    .main-content {
        display: flex;
        flex-direction: column;
        background: var(--bg-color);
        overflow: hidden;
    }

    .content-header {
        padding: 15px 20px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .content-header h2 {
        font-size: 1.1rem;
    }

    .header-title {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .replay-label {
        background: var(--primary-color);
        color: #000;
        font-weight: 600;
        font-size: 0.75rem;
        padding: 3px 8px;
        border-radius: 4px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .drug-name {
        color: var(--primary-color);
        font-weight: 600;
    }

    .content-header .back-link {
        font-size: 0.85rem;
    }

    .session-navigation {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 15px;
        padding: 6px 20px;
        background: var(--card-color);
        border-bottom: 1px solid var(--border-color);
    }

    .nav-btn {
        padding: 3px 12px;
        background: var(--primary-color);
        color: #000;
        border: none;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }

    .nav-btn:hover:not(:disabled) {
        background: #00b8e6;
    }

    .nav-btn:disabled {
        background: #333;
        color: #666;
        cursor: not-allowed;
    }

    .nav-info {
        font-size: 0.8rem;
        color: var(--text-muted);
    }

    .nav-info span:first-child {
        color: var(--primary-color);
        font-weight: 600;
    }

    .image-container {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
        overflow: auto;
        position: relative;
    }

    .canvas-wrapper {
        position: relative;
        display: inline-block;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        border-radius: 8px;
        overflow: hidden;
    }

    #sampleImage {
        display: block;
        max-width: 100%;
        max-height: calc(100vh - 200px);
        width: auto;
        height: auto;
    }

    #replayCanvas {
        position: absolute;
        top: 0;
        left: 0;
        pointer-events: none;
    }

    .playback-controls {
        padding: 15px 20px;
        background: var(--sidebar-color);
        border-top: 1px solid var(--border-color);
    }

    .timeline-container {
        margin-bottom: 10px;
    }

    .timeline {
        width: 100%;
        height: 8px;
        background: var(--border-color);
        border-radius: 4px;
        cursor: pointer;
        position: relative;
    }

    .timeline-progress {
        height: 100%;
        background: var(--primary-color);
        border-radius: 4px;
        width: 0%;
        transition: width 0.1s linear;
    }

    .timeline-markers {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        pointer-events: none;
    }

    .timeline-marker {
        position: absolute;
        top: -2px;
        width: 4px;
        height: 12px;
        background: var(--success-color);
        border-radius: 2px;
        transform: translateX(-50%);
    }

    .controls-row {
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .play-btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: var(--primary-color);
        color: #000;
        border: none;
        cursor: pointer;
        font-size: 1rem;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s;
    }

    .play-btn:hover {
        background: #00b8e6;
    }

    .time-display {
        font-family: monospace;
        font-size: 0.9rem;
        color: var(--text-muted);
        min-width: 100px;
    }

    .speed-control {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-left: auto;
    }

    .speed-control label {
        font-size: 0.8rem;
        color: var(--text-muted);
    }

    .speed-btn {
        padding: 4px 10px;
        background: #333;
        border: 1px solid var(--border-color);
        color: var(--text-color);
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.75rem;
        transition: all 0.2s;
    }

    .speed-btn:hover {
        background: #444;
    }

    .speed-btn.active {
        background: var(--primary-color);
        color: #000;
        border-color: var(--primary-color);
    }

    .mode-toggle {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .mode-toggle label {
        font-size: 0.8rem;
        color: var(--text-muted);
    }

    .mode-btn {
        padding: 4px 10px;
        background: #333;
        border: 1px solid var(--border-color);
        color: var(--text-color);
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.75rem;
        transition: all 0.2s;
    }

    .mode-btn:hover {
        background: #444;
    }

    .mode-btn.active {
        background: var(--success-color);
        color: #000;
        border-color: var(--success-color);
    }

    /* Right panel - Annotations list */
    .annotations-panel {
        background: var(--sidebar-color);
        border-left: 1px solid var(--border-color);
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .panel-header {
        padding: 15px;
        border-bottom: 1px solid var(--border-color);
    }

    .panel-header h3 {
        font-size: 0.9rem;
        color: var(--primary-color);
    }

    .session-info {
        padding: 12px 15px;
        background: var(--card-color);
        border-bottom: 1px solid var(--border-color);
        font-size: 0.8rem;
    }

    .session-info .info-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 6px;
    }

    .session-info .info-row:last-child {
        margin-bottom: 0;
    }

    .session-info .label {
        color: var(--text-muted);
    }

    .annotations-list {
        flex: 1;
        overflow-y: auto;
        padding: 10px;
    }

    .annotation-item {
        padding: 10px 12px;
        background: var(--card-color);
        border-radius: 8px;
        margin-bottom: 8px;
        border-left: 3px solid var(--primary-color);
        cursor: pointer;
        transition: all 0.2s;
    }

    .annotation-item:hover {
        background: rgba(255, 255, 255, 0.05);
    }

    .annotation-item.active {
        border-left-color: var(--success-color);
        background: rgba(46, 213, 115, 0.1);
    }

    .annotation-item .time {
        font-size: 0.7rem;
        color: var(--primary-color);
        font-family: monospace;
        margin-bottom: 4px;
    }

    .annotation-item .type {
        font-size: 0.8rem;
        color: var(--text-color);
    }

    .annotation-item .lanes {
        font-size: 0.7rem;
        color: var(--text-muted);
        margin-top: 2px;
    }

    .annotation-item .color-indicator {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 6px;
        vertical-align: middle;
    }

    .no-audio-notice {
        padding: 10px 15px;
        background: rgba(255, 165, 2, 0.1);
        border: 1px solid var(--warning-color);
        border-radius: 8px;
        margin: 10px;
        font-size: 0.8rem;
        color: var(--warning-color);
    }

    /* Loading state */
    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(26, 26, 46, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 100;
    }
</style>
{% endblock %}

{% block body %}
<div class="layout">
    <aside class="sidebar">
        <div class="sidebar-header">
            <h1>PAD Annotation</h1>
            <p>Admin Panel</p>
        </div>

        <nav>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="/admin" class="nav-link">
                        <span class="icon">üìä</span>
                        Dashboard
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/admin/studies" class="nav-link">
                        <span class="icon">üìã</span>
                        Studies
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/admin/users?role=specialist" class="nav-link">
                        <span class="icon">üî¨</span>
                        Specialists
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/admin/users" class="nav-link">
                        <span class="icon">üë•</span>
                        Users
                    </a>
                </li>
            </ul>
        </nav>

        <div class="logout-link">
            <div class="user-info">{{ user.name }}</div>
            <a href="#" class="nav-link" onclick="logout()">
                <span class="icon">üö™</span>
                Logout
            </a>
        </div>
    </aside>

    <main class="main-content">
        <div class="content-header">
            <div class="header-title">
                <h2><span class="replay-label">‚ñ∂ Replay</span> <span class="drug-name" id="drugName">-</span></h2>
                <span class="badge badge-secondary" id="sampleBadge">Loading...</span>
            </div>
            <a href="/admin/studies/{{ study_id }}/progress" class="back-link">‚Üê Back to Progress</a>
        </div>

        <div class="session-navigation" id="sessionNavigation">
            <button class="nav-btn" id="prevBtn" onclick="navigateToPrevious()" disabled>
                ‚Üê Prev
            </button>
            <span class="nav-info">
                <span id="navCurrent">-</span> of <span id="navTotal">-</span>
            </span>
            <button class="nav-btn" id="nextBtn" onclick="navigateToNext()" disabled>
                Next ‚Üí
            </button>
        </div>

        <div class="image-container" id="imageContainer">
            <div class="loading-overlay" id="loadingOverlay">
                <div class="spinner"></div>
            </div>
            <div class="canvas-wrapper">
                <img id="sampleImage" />
                <canvas id="replayCanvas"></canvas>
            </div>
        </div>

        <div class="playback-controls">
            <div class="timeline-container">
                <div class="timeline" id="timeline" onclick="seekTimeline(event)">
                    <div class="timeline-progress" id="timelineProgress"></div>
                    <div class="timeline-markers" id="timelineMarkers"></div>
                </div>
            </div>
            <div class="controls-row">
                <button class="play-btn" id="playBtn" onclick="togglePlayback()">‚ñ∂</button>
                <div class="time-display">
                    <span id="currentTime">00:00</span> / <span id="totalTime">00:00</span>
                </div>
                <div class="mode-toggle">
                    <label>Mode:</label>
                    <button class="mode-btn active" id="animatedModeBtn" onclick="setMode('animated')">Animated</button>
                    <button class="mode-btn" id="staticModeBtn" onclick="setMode('static')">Static</button>
                </div>
                <div class="speed-control">
                    <label>Speed:</label>
                    <button class="speed-btn" onclick="setSpeed(0.5)">0.5x</button>
                    <button class="speed-btn active" onclick="setSpeed(1)">1x</button>
                    <button class="speed-btn" onclick="setSpeed(1.5)">1.5x</button>
                    <button class="speed-btn" onclick="setSpeed(2)">2x</button>
                </div>
            </div>
        </div>
    </main>

    <aside class="annotations-panel">
        <div class="panel-header">
            <h3>Session Details</h3>
        </div>
        <div class="session-info" id="sessionInfo">
            <div class="info-row">
                <span class="label">Specialist:</span>
                <span id="specialistName">-</span>
            </div>
            <div class="info-row">
                <span class="label">Completed:</span>
                <span id="completedAt">-</span>
            </div>
            <div class="info-row">
                <span class="label">Duration:</span>
                <span id="sessionDuration">-</span>
            </div>
            <div class="info-row">
                <span class="label">Annotations:</span>
                <span id="annotationCount">-</span>
            </div>
        </div>
        <div id="noAudioNotice" class="no-audio-notice" style="display: none;">
            No audio recorded for this session. Playback uses timestamps only.
        </div>
        <div class="panel-header">
            <h3>Annotations</h3>
        </div>
        <div class="annotations-list" id="annotationsList">
            <div class="loading">
                <div class="spinner"></div>
            </div>
        </div>
    </aside>
</div>
{% endblock %}

{% block scripts %}
<script>
    const studyId = {{ study_id }};
    const sessionId = {{ session_id }};

    // State
    let replayData = null;
    let isPlaying = false;
    let currentTime = 0;
    let playbackSpeed = 1;
    let playbackMode = 'animated'; // 'animated' or 'static'
    let animationFrameId = null;
    let lastFrameTime = null;
    let audio = null;

    // Canvas
    const canvas = document.getElementById('replayCanvas');
    const ctx = canvas.getContext('2d');
    const sampleImage = document.getElementById('sampleImage');

    async function loadReplayData() {
        try {
            replayData = await apiCall(`/api/admin/sessions/${sessionId}/replay-data`);
            setupReplay();
        } catch (error) {
            showError('Failed to load session data: ' + error.message);
        }
    }

    function setupReplay() {
        // Update page info
        document.getElementById('drugName').textContent = replayData.sample.drug_name_display;
        document.getElementById('sampleBadge').textContent = `Card #${replayData.sample.card_id}`;

        // Update session info
        document.getElementById('specialistName').textContent = replayData.specialist.name;
        document.getElementById('completedAt').textContent = formatDate(replayData.session.completed_at);
        document.getElementById('sessionDuration').textContent = formatDuration(replayData.session.audio_duration_ms);
        document.getElementById('annotationCount').textContent = replayData.annotations.length;

        // Load image
        sampleImage.onload = () => {
            canvas.width = sampleImage.naturalWidth;
            canvas.height = sampleImage.naturalHeight;
            canvas.style.width = sampleImage.width + 'px';
            canvas.style.height = sampleImage.height + 'px';
            document.getElementById('loadingOverlay').style.display = 'none';

            // Initial render
            renderAnnotations();
            renderAnnotationsList();
            renderTimelineMarkers();
            setupNavigation();
        };
        sampleImage.src = `/${replayData.sample.image_path}`;

        // Setup audio if available
        if (replayData.audio_url) {
            console.log('Loading audio from:', replayData.audio_url);
            audio = new Audio(replayData.audio_url);

            audio.addEventListener('loadedmetadata', () => {
                console.log('Audio loaded, duration:', audio.duration);
                document.getElementById('totalTime').textContent = formatTime(audio.duration * 1000);
            });

            audio.addEventListener('canplaythrough', () => {
                console.log('Audio can play through');
            });

            audio.addEventListener('timeupdate', () => {
                if (isPlaying && playbackMode === 'animated') {
                    currentTime = audio.currentTime * 1000;
                    updatePlaybackUI();
                    renderAnnotations();
                    updateActiveAnnotation();
                }
            });

            audio.addEventListener('ended', () => {
                stopPlayback();
            });

            audio.addEventListener('error', (e) => {
                console.error('Audio error:', e);
                console.error('Audio error code:', audio.error?.code, 'message:', audio.error?.message);
                // Fall back to timer-based playback
                document.getElementById('noAudioNotice').style.display = 'block';
                document.getElementById('noAudioNotice').textContent =
                    'Audio playback error. Using timestamps for visual replay.';
                audio = null;
                const duration = replayData.session.audio_duration_ms || getMaxAnnotationTime();
                document.getElementById('totalTime').textContent = formatTime(duration);
            });

            // Preload the audio
            audio.preload = 'auto';
            audio.load();
        } else {
            // No audio - use session duration for timeline
            document.getElementById('noAudioNotice').style.display = 'block';
            const duration = replayData.session.audio_duration_ms || getMaxAnnotationTime();
            document.getElementById('totalTime').textContent = formatTime(duration);
        }
    }

    function getMaxAnnotationTime() {
        if (!replayData || !replayData.annotations.length) return 0;
        return Math.max(...replayData.annotations.map(a => a.timestamp_end_ms || 0));
    }

    function getTotalDuration() {
        if (audio && audio.duration) {
            return audio.duration * 1000;
        }
        return replayData.session.audio_duration_ms || getMaxAnnotationTime() || 60000;
    }

    function renderAnnotations() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        for (const ann of replayData.annotations) {
            // In static mode, show all annotations
            // In animated mode, show only those that have started by currentTime
            if (playbackMode === 'static' || (ann.timestamp_start_ms !== null && ann.timestamp_start_ms <= currentTime)) {
                drawAnnotation(ann);
            }
        }
    }

    function drawAnnotation(ann) {
        ctx.strokeStyle = ann.color || '#00d4ff';
        ctx.lineWidth = 3;

        if (ann.type === 'rectangle' && ann.bbox_normalized) {
            const bbox = ann.bbox_normalized;
            const x = (bbox.x1 / 999) * canvas.width;
            const y = (bbox.y1 / 999) * canvas.height;
            const width = ((bbox.x2 - bbox.x1) / 999) * canvas.width;
            const height = ((bbox.y2 - bbox.y1) / 999) * canvas.height;
            ctx.strokeRect(x, y, width, height);
        } else if (ann.type === 'polygon' && ann.points_normalized) {
            ctx.beginPath();
            const firstPoint = ann.points_normalized[0];
            ctx.moveTo((firstPoint.x / 999) * canvas.width, (firstPoint.y / 999) * canvas.height);
            for (let i = 1; i < ann.points_normalized.length; i++) {
                const point = ann.points_normalized[i];
                ctx.lineTo((point.x / 999) * canvas.width, (point.y / 999) * canvas.height);
            }
            ctx.closePath();
            ctx.stroke();
        }
    }

    function renderAnnotationsList() {
        const list = document.getElementById('annotationsList');
        if (replayData.annotations.length === 0) {
            list.innerHTML = '<div class="empty-state"><p>No annotations</p></div>';
            return;
        }

        list.innerHTML = replayData.annotations.map((ann, idx) => `
            <div class="annotation-item" data-index="${idx}" onclick="seekToAnnotation(${idx})">
                <div class="time">${formatTimeRange(ann.timestamp_start_ms, ann.timestamp_end_ms)}</div>
                <div class="type">
                    <span class="color-indicator" style="background: ${ann.color || '#00d4ff'}"></span>
                    ${ann.type}
                </div>
                <div class="lanes">${ann.lanes && ann.lanes.length ? 'Lanes: ' + ann.lanes.join(', ') : 'No lanes detected'}</div>
            </div>
        `).join('');
    }

    function renderTimelineMarkers() {
        const markers = document.getElementById('timelineMarkers');
        const totalDuration = getTotalDuration();

        markers.innerHTML = replayData.annotations.map(ann => {
            if (ann.timestamp_start_ms === null) return '';
            const percent = (ann.timestamp_start_ms / totalDuration) * 100;
            return `<div class="timeline-marker" style="left: ${percent}%"></div>`;
        }).join('');
    }

    function togglePlayback() {
        if (isPlaying) {
            stopPlayback();
        } else {
            // If at the end, restart from beginning
            const totalDuration = getTotalDuration();
            if (currentTime >= totalDuration - 100) { // 100ms tolerance
                currentTime = 0;
                if (audio) {
                    audio.currentTime = 0;
                }
                updatePlaybackUI();
                renderAnnotations();
            }
            startPlayback();
        }
    }

    function startPlayback() {
        isPlaying = true;
        document.getElementById('playBtn').textContent = '‚è∏';

        if (audio && playbackMode === 'animated') {
            audio.playbackRate = playbackSpeed;
            audio.currentTime = currentTime / 1000;

            // audio.play() returns a Promise - handle potential errors
            const playPromise = audio.play();
            if (playPromise !== undefined) {
                playPromise.then(() => {
                    console.log('Audio playback started successfully');
                }).catch(error => {
                    console.error('Audio playback failed:', error);
                    // Fall back to timer-based playback
                    lastFrameTime = performance.now();
                    requestAnimationFrame(timerPlayback);
                });
            }
        } else {
            // Timer-based playback (no audio or static mode preview)
            lastFrameTime = performance.now();
            requestAnimationFrame(timerPlayback);
        }
    }

    function stopPlayback() {
        isPlaying = false;
        document.getElementById('playBtn').textContent = '‚ñ∂';

        if (audio) {
            audio.pause();
        }

        if (animationFrameId) {
            cancelAnimationFrame(animationFrameId);
            animationFrameId = null;
        }
    }

    function timerPlayback(timestamp) {
        if (!isPlaying) return;

        if (lastFrameTime) {
            const delta = timestamp - lastFrameTime;
            currentTime += delta * playbackSpeed;
        }
        lastFrameTime = timestamp;

        const totalDuration = getTotalDuration();
        if (currentTime >= totalDuration) {
            currentTime = totalDuration;
            stopPlayback();
        }

        updatePlaybackUI();
        renderAnnotations();
        updateActiveAnnotation();

        if (isPlaying) {
            animationFrameId = requestAnimationFrame(timerPlayback);
        }
    }

    function updatePlaybackUI() {
        const totalDuration = getTotalDuration();
        const percent = (currentTime / totalDuration) * 100;
        document.getElementById('timelineProgress').style.width = percent + '%';
        document.getElementById('currentTime').textContent = formatTime(currentTime);
    }

    function updateActiveAnnotation() {
        // Highlight the current annotation in the list
        document.querySelectorAll('.annotation-item').forEach((el, idx) => {
            const ann = replayData.annotations[idx];
            const isActive = ann.timestamp_start_ms !== null &&
                            ann.timestamp_start_ms <= currentTime &&
                            (ann.timestamp_end_ms === null || ann.timestamp_end_ms >= currentTime);
            el.classList.toggle('active', isActive);
        });
    }

    function seekTimeline(event) {
        const timeline = document.getElementById('timeline');
        const rect = timeline.getBoundingClientRect();
        const percent = (event.clientX - rect.left) / rect.width;
        const totalDuration = getTotalDuration();
        currentTime = percent * totalDuration;

        if (audio) {
            audio.currentTime = currentTime / 1000;
        }

        updatePlaybackUI();
        renderAnnotations();
        updateActiveAnnotation();
    }

    function seekToAnnotation(index) {
        const ann = replayData.annotations[index];
        if (ann.timestamp_start_ms !== null) {
            currentTime = ann.timestamp_start_ms;

            if (audio) {
                audio.currentTime = currentTime / 1000;
            }

            updatePlaybackUI();
            renderAnnotations();
            updateActiveAnnotation();
        }
    }

    function setSpeed(speed) {
        playbackSpeed = speed;

        // Update UI
        document.querySelectorAll('.speed-btn').forEach(btn => {
            btn.classList.toggle('active', btn.textContent === speed + 'x');
        });

        // Update audio playback rate if playing
        if (audio && isPlaying) {
            audio.playbackRate = speed;
        }
    }

    function setMode(mode) {
        playbackMode = mode;

        // Update UI
        document.getElementById('animatedModeBtn').classList.toggle('active', mode === 'animated');
        document.getElementById('staticModeBtn').classList.toggle('active', mode === 'static');

        // Re-render
        renderAnnotations();
    }

    function formatTime(ms) {
        if (ms === null || ms === undefined) return '--:--';
        const totalSeconds = Math.floor(ms / 1000);
        const minutes = Math.floor(totalSeconds / 60);
        const seconds = totalSeconds % 60;
        return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    function formatDuration(ms) {
        if (!ms) return '-';
        return formatTime(ms);
    }

    function formatTimeRange(startMs, endMs) {
        if (startMs === null || endMs === null) {
            return 'No timestamp';
        }
        return `${formatTime(startMs)} ‚Üí ${formatTime(endMs)}`;
    }

    // Navigation functions
    function setupNavigation() {
        const nav = replayData.navigation;
        if (!nav) return;

        document.getElementById('navCurrent').textContent = nav.current_index;
        document.getElementById('navTotal').textContent = nav.total_sessions;

        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');

        if (nav.previous_session_id) {
            prevBtn.disabled = false;
        } else {
            prevBtn.disabled = true;
        }

        if (nav.next_session_id) {
            nextBtn.disabled = false;
        } else {
            nextBtn.disabled = true;
        }
    }

    function navigateToPrevious() {
        const nav = replayData.navigation;
        if (nav && nav.previous_session_id) {
            window.location.href = `/admin/studies/${studyId}/sessions/${nav.previous_session_id}/replay`;
        }
    }

    function navigateToNext() {
        const nav = replayData.navigation;
        if (nav && nav.next_session_id) {
            window.location.href = `/admin/studies/${studyId}/sessions/${nav.next_session_id}/replay`;
        }
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
        // Ignore if typing in an input
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

        switch(e.key) {
            case 'ArrowLeft':
                if (!e.ctrlKey && !e.metaKey) {
                    e.preventDefault();
                    navigateToPrevious();
                }
                break;
            case 'ArrowRight':
                if (!e.ctrlKey && !e.metaKey) {
                    e.preventDefault();
                    navigateToNext();
                }
                break;
            case ' ':
                e.preventDefault();
                togglePlayback();
                break;
        }
    });

    // Initialize
    loadReplayData();
</script>
{% endblock %}
