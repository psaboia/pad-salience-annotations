{% extends "base.html" %}

{% block title %}New Experiment - PAD Annotation System{% endblock %}

{% block head %}
<style>
    .layout {
        display: grid;
        grid-template-columns: 240px 1fr;
        min-height: 100vh;
    }

    .sidebar {
        background: var(--sidebar-color);
        border-right: 1px solid var(--border-color);
        padding: 20px;
    }

    .sidebar-header {
        margin-bottom: 30px;
    }

    .sidebar-header h1 {
        font-size: 1.1rem;
        color: var(--primary-color);
    }

    .nav-menu {
        list-style: none;
    }

    .nav-item {
        margin-bottom: 4px;
    }

    .nav-link {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 12px;
        border-radius: 8px;
        color: var(--text-color);
        text-decoration: none;
        font-size: 0.9rem;
        transition: all 0.2s;
    }

    .nav-link:hover {
        background: rgba(255, 255, 255, 0.05);
        text-decoration: none;
    }

    .main-content {
        padding: 30px;
        overflow-y: auto;
    }

    .page-header {
        margin-bottom: 30px;
    }

    .page-header h2 {
        font-size: 1.5rem;
    }

    .wizard-steps {
        display: flex;
        gap: 20px;
        margin-bottom: 30px;
    }

    .wizard-step {
        flex: 1;
        text-align: center;
        padding: 12px;
        background: var(--card-color);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-size: 0.85rem;
        color: var(--text-muted);
    }

    .wizard-step.active {
        border-color: var(--primary-color);
        color: var(--primary-color);
    }

    .wizard-step.completed {
        border-color: var(--success-color);
        color: var(--success-color);
    }

    .step-content {
        display: none;
    }

    .step-content.active {
        display: block;
    }

    .sample-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 12px;
        max-height: 400px;
        overflow-y: auto;
        padding: 4px;
    }

    .sample-card {
        background: var(--card-color);
        border: 2px solid var(--border-color);
        border-radius: 8px;
        padding: 12px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .sample-card:hover {
        border-color: var(--primary-color);
    }

    .sample-card.selected {
        border-color: var(--success-color);
        background: rgba(46, 213, 115, 0.1);
    }

    .sample-card img {
        width: 100%;
        height: 80px;
        object-fit: cover;
        border-radius: 4px;
        margin-bottom: 8px;
    }

    .sample-card .name {
        font-size: 0.85rem;
        font-weight: 500;
    }

    .sample-card .card-id {
        font-size: 0.75rem;
        color: var(--text-muted);
    }

    .specialist-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .specialist-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        background: var(--card-color);
        border: 2px solid var(--border-color);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .specialist-item:hover {
        border-color: var(--primary-color);
    }

    .specialist-item.selected {
        border-color: var(--success-color);
        background: rgba(46, 213, 115, 0.1);
    }

    .specialist-item input[type="checkbox"] {
        width: 18px;
        height: 18px;
    }

    .specialist-info .name {
        font-weight: 500;
    }

    .specialist-info .email {
        font-size: 0.8rem;
        color: var(--text-muted);
    }

    .wizard-actions {
        display: flex;
        justify-content: space-between;
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid var(--border-color);
    }

    .selection-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding: 10px 15px;
        background: var(--sidebar-color);
        border-radius: 8px;
    }

    .selection-info .count {
        font-weight: 500;
        color: var(--primary-color);
    }
</style>
{% endblock %}

{% block body %}
<div class="layout">
    <aside class="sidebar">
        <div class="sidebar-header">
            <h1>PAD Annotation</h1>
        </div>
        <nav>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="/admin" class="nav-link">
                        <span class="icon">ðŸ“Š</span>
                        Dashboard
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/admin/experiments/new" class="nav-link active">
                        <span class="icon">âž•</span>
                        New Experiment
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/admin/users" class="nav-link">
                        <span class="icon">ðŸ‘¥</span>
                        Users
                    </a>
                </li>
            </ul>
        </nav>
    </aside>

    <main class="main-content">
        <div class="page-header">
            <h2>Create New Experiment</h2>
        </div>

        <div class="wizard-steps">
            <div class="wizard-step active" id="step1-indicator">1. Basic Info</div>
            <div class="wizard-step" id="step2-indicator">2. Select Samples</div>
            <div class="wizard-step" id="step3-indicator">3. Assign Specialists</div>
        </div>

        <!-- Step 1: Basic Info -->
        <div class="step-content active" id="step1">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Experiment Details</h3>
                </div>
                <form id="basicInfoForm">
                    <div class="form-group">
                        <label for="name">Experiment Name *</label>
                        <input type="text" id="name" class="form-control" placeholder="e.g., Drug Classification Study v1" required>
                    </div>
                    <div class="form-group">
                        <label for="description">Description</label>
                        <textarea id="description" class="form-control" placeholder="Brief description of the experiment"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="instructions">Instructions for Specialists</label>
                        <textarea id="instructions" class="form-control" placeholder="Detailed instructions that will be shown to specialists"></textarea>
                    </div>
                </form>
                <div class="wizard-actions">
                    <a href="/admin" class="btn btn-secondary">Cancel</a>
                    <button type="button" class="btn btn-primary" onclick="goToStep(2)">Next: Select Samples</button>
                </div>
            </div>
        </div>

        <!-- Step 2: Select Samples -->
        <div class="step-content" id="step2">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Select Samples</h3>
                </div>
                <div class="selection-info">
                    <span><span class="count" id="selectedSamplesCount">0</span> samples selected</span>
                    <button type="button" class="btn btn-secondary btn-sm" onclick="toggleAllSamples()">Toggle All</button>
                </div>
                <div class="sample-grid" id="sampleGrid">
                    <div class="loading">
                        <div class="spinner"></div>
                    </div>
                </div>
                <div class="wizard-actions">
                    <button type="button" class="btn btn-secondary" onclick="goToStep(1)">Back</button>
                    <button type="button" class="btn btn-primary" onclick="goToStep(3)">Next: Assign Specialists</button>
                </div>
            </div>
        </div>

        <!-- Step 3: Assign Specialists -->
        <div class="step-content" id="step3">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Assign Specialists</h3>
                </div>
                <div class="selection-info">
                    <span><span class="count" id="selectedSpecialistsCount">0</span> specialists assigned</span>
                </div>
                <div class="specialist-list" id="specialistList">
                    <div class="loading">
                        <div class="spinner"></div>
                    </div>
                </div>
                <div class="wizard-actions">
                    <button type="button" class="btn btn-secondary" onclick="goToStep(2)">Back</button>
                    <button type="button" class="btn btn-success" onclick="createExperiment()" id="createBtn">Create Experiment</button>
                </div>
            </div>
        </div>
    </main>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentStep = 1;
    let samples = [];
    let specialists = [];
    let selectedSamples = new Set();
    let selectedSpecialists = new Set();
    let experimentId = null;

    async function loadData() {
        try {
            // Load samples
            samples = await apiCall('/api/admin/samples');
            renderSamples();

            // Load specialists
            specialists = await apiCall('/api/admin/specialists');
            renderSpecialists();
        } catch (error) {
            showError(error.message);
        }
    }

    function renderSamples() {
        const grid = document.getElementById('sampleGrid');
        grid.innerHTML = samples.map(s => `
            <div class="sample-card ${selectedSamples.has(s.id) ? 'selected' : ''}"
                 onclick="toggleSample(${s.id})">
                <img src="/${s.image_path}" alt="${s.drug_name_display}">
                <div class="name">${s.drug_name_display}</div>
                <div class="card-id">Card #${s.card_id}</div>
            </div>
        `).join('');
        updateSelectedCounts();
    }

    function renderSpecialists() {
        const list = document.getElementById('specialistList');
        if (specialists.length === 0) {
            list.innerHTML = `
                <div class="empty-state">
                    <h3>No specialists available</h3>
                    <p>Create specialist accounts first</p>
                </div>
            `;
            return;
        }
        list.innerHTML = specialists.map(s => `
            <div class="specialist-item ${selectedSpecialists.has(s.id) ? 'selected' : ''}"
                 onclick="toggleSpecialist(${s.id})">
                <input type="checkbox" ${selectedSpecialists.has(s.id) ? 'checked' : ''}>
                <div class="specialist-info">
                    <div class="name">${s.name}</div>
                    <div class="email">${s.email}</div>
                </div>
            </div>
        `).join('');
        updateSelectedCounts();
    }

    function toggleSample(id) {
        if (selectedSamples.has(id)) {
            selectedSamples.delete(id);
        } else {
            selectedSamples.add(id);
        }
        renderSamples();
    }

    function toggleSpecialist(id) {
        if (selectedSpecialists.has(id)) {
            selectedSpecialists.delete(id);
        } else {
            selectedSpecialists.add(id);
        }
        renderSpecialists();
    }

    function toggleAllSamples() {
        if (selectedSamples.size === samples.length) {
            selectedSamples.clear();
        } else {
            samples.forEach(s => selectedSamples.add(s.id));
        }
        renderSamples();
    }

    function updateSelectedCounts() {
        document.getElementById('selectedSamplesCount').textContent = selectedSamples.size;
        document.getElementById('selectedSpecialistsCount').textContent = selectedSpecialists.size;
    }

    function goToStep(step) {
        // Validate current step
        if (step > currentStep) {
            if (currentStep === 1) {
                const name = document.getElementById('name').value.trim();
                if (!name) {
                    showError('Please enter an experiment name');
                    return;
                }
            } else if (currentStep === 2) {
                if (selectedSamples.size === 0) {
                    showError('Please select at least one sample');
                    return;
                }
            }
        }

        // Update step indicators
        for (let i = 1; i <= 3; i++) {
            const indicator = document.getElementById(`step${i}-indicator`);
            const content = document.getElementById(`step${i}`);
            indicator.classList.remove('active', 'completed');
            content.classList.remove('active');

            if (i < step) {
                indicator.classList.add('completed');
            } else if (i === step) {
                indicator.classList.add('active');
                content.classList.add('active');
            }
        }

        currentStep = step;
    }

    async function createExperiment() {
        if (selectedSamples.size === 0) {
            showError('Please select at least one sample');
            return;
        }

        const createBtn = document.getElementById('createBtn');
        createBtn.disabled = true;
        createBtn.textContent = 'Creating...';

        try {
            // Step 1: Create experiment
            const expData = {
                name: document.getElementById('name').value.trim(),
                description: document.getElementById('description').value.trim() || null,
                instructions: document.getElementById('instructions').value.trim() || null
            };
            const experiment = await apiCall('/api/admin/experiments', {
                method: 'POST',
                body: JSON.stringify(expData)
            });
            experimentId = experiment.id;

            // Step 2: Add samples
            await apiCall(`/api/admin/experiments/${experimentId}/samples`, {
                method: 'POST',
                body: JSON.stringify({ sample_ids: Array.from(selectedSamples) })
            });

            // Step 3: Assign specialists
            for (const specialistId of selectedSpecialists) {
                await apiCall(`/api/admin/experiments/${experimentId}/assignments`, {
                    method: 'POST',
                    body: JSON.stringify({ specialist_id: specialistId })
                });
            }

            // Success - redirect to experiment detail
            window.location.href = `/admin/experiments/${experimentId}`;

        } catch (error) {
            showError(error.message);
            createBtn.disabled = false;
            createBtn.textContent = 'Create Experiment';
        }
    }

    // Load data on page load
    loadData();
</script>
{% endblock %}
